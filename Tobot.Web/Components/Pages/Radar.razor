@page "/radar"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using Tobot.Web.Hubs
@implements IAsyncDisposable
@inject NavigationManager Navigation

<PageTitle>Radar</PageTitle>

<div class="radar-screen">
    <svg class="radar-svg" viewBox="0 0 400 220" preserveAspectRatio="xMidYMax meet">
        <defs>
            <radialGradient id="radarGlow" cx="50%" cy="100%" r="100%">
                <stop offset="0%" stop-color="#1a3a1a" />
                <stop offset="100%" stop-color="#0a140a" />
            </radialGradient>
            <clipPath id="arcClip">
                <path d="M 200 200 L 25 25 A 175 175 0 0 1 375 25 L 200 200 Z" />
            </clipPath>
        </defs>

        <rect x="0" y="0" width="400" height="220" fill="#050a05" />

        <g clip-path="url(#arcClip)">
            <circle cx="200" cy="200" r="175" fill="url(#radarGlow)" />

            <circle cx="200" cy="200" r="@Ring1R" fill="none" stroke="#1a4a1a" stroke-width="1" opacity="0.6" />
            <circle cx="200" cy="200" r="@Ring2R" fill="none" stroke="#1a4a1a" stroke-width="1" opacity="0.6" />
            <circle cx="200" cy="200" r="@Ring3R" fill="none" stroke="#1a4a1a" stroke-width="1" opacity="0.5" />

            <text x="200" y="@(200 - Ring1R - 4)" text-anchor="middle" fill="#2a6a2a" font-size="10" font-family="monospace">20</text>
            <text x="200" y="@(200 - Ring2R - 4)" text-anchor="middle" fill="#2a6a2a" font-size="10" font-family="monospace">40</text>
            <text x="200" y="@(200 - Ring3R - 4)" text-anchor="middle" fill="#2a6a2a" font-size="10" font-family="monospace">60</text>

            <line x1="200" y1="200" x2="@AngleLineX(-45)" y2="@AngleLineY(-45)" stroke="#1a4a1a" stroke-width="1" opacity="0.4" />
            <line x1="200" y1="200" x2="@AngleLineX(-30)" y2="@AngleLineY(-30)" stroke="#1a4a1a" stroke-width="1" opacity="0.3" />
            <line x1="200" y1="200" x2="@AngleLineX(-15)" y2="@AngleLineY(-15)" stroke="#1a4a1a" stroke-width="1" opacity="0.3" />
            <line x1="200" y1="200" x2="200" y2="25" stroke="#1a4a1a" stroke-width="1" opacity="0.4" />
            <line x1="200" y1="200" x2="@AngleLineX(15)" y2="@AngleLineY(15)" stroke="#1a4a1a" stroke-width="1" opacity="0.3" />
            <line x1="200" y1="200" x2="@AngleLineX(30)" y2="@AngleLineY(30)" stroke="#1a4a1a" stroke-width="1" opacity="0.3" />
            <line x1="200" y1="200" x2="@AngleLineX(45)" y2="@AngleLineY(45)" stroke="#1a4a1a" stroke-width="1" opacity="0.4" />

            <g class="sweep-line">
                <line x1="200" y1="200" x2="200" y2="25" stroke="#3a8a3a" stroke-width="2" opacity="0.7" />
                <line x1="200" y1="200" x2="200" y2="25" stroke="#5aff5a" stroke-width="1" opacity="0.4" />
            </g>

            @if (_hasDetection)
            {
                <circle cx="@BlipX" cy="@BlipY" r="6" fill="#5aff5a" opacity="0.9">
                    <animate attributeName="r" values="4;8;4" dur="1.2s" repeatCount="indefinite" />
                    <animate attributeName="opacity" values="1;0.5;1" dur="1.2s" repeatCount="indefinite" />
                </circle>
                <circle cx="@BlipX" cy="@BlipY" r="3" fill="#aaffaa" />
            }
        </g>

        <path d="M 25 25 A 175 175 0 0 1 375 25" fill="none" stroke="#2a6a2a" stroke-width="2" />
        <line x1="200" y1="200" x2="25" y2="25" stroke="#2a6a2a" stroke-width="1" />
        <line x1="200" y1="200" x2="375" y2="25" stroke="#2a6a2a" stroke-width="1" />

        <circle cx="200" cy="200" r="4" fill="#3a8a3a" />

        <text x="18" y="18" text-anchor="middle" fill="#3a8a3a" font-size="11" font-family="monospace">-45</text>
        <text x="200" y="14" text-anchor="middle" fill="#3a8a3a" font-size="11" font-family="monospace">0</text>
        <text x="382" y="18" text-anchor="middle" fill="#3a8a3a" font-size="11" font-family="monospace">+45</text>
    </svg>

    <div class="detection-info">
        @if (_hasDetection)
        {
            <span>X: @XCoord cm | Y: @YCoord cm | D: @DistanceText</span>
        }
        else
        {
            <span>No detection</span>
        }
    </div>
</div>

@code {
    private HubConnection? _hubConnection;
    private CancellationTokenSource? _scanCts;
    private CancellationTokenSource? _componentCts;
    private Task? _scanTask;

    private double? _distanceCm;
    private int? _panAngle;
    private int _sweepAngle = -45;
    private bool _hasDetection;

    private const double MaxDistanceCm = 60.0;
    private const double RadarRadius = 175.0;
    private const int SweepIncrement = 5;
    private const int SamplesPerReading = 5;
    private static readonly TimeSpan ScanInterval = TimeSpan.FromMilliseconds(2000);

    private double Ring1R => RadarRadius * (20.0 / MaxDistanceCm);
    private double Ring2R => RadarRadius * (40.0 / MaxDistanceCm);
    private double Ring3R => RadarRadius * (60.0 / MaxDistanceCm);

    private string DistanceText => _distanceCm.HasValue ? $"{_distanceCm.Value:F1} cm" : "--";
    private string XCoord => _hasDetection ? $"{CalculateX():F1}" : "--";
    private string YCoord => _hasDetection ? $"{CalculateY():F1}" : "--";

    private double CalculateX()
    {
        if (!_distanceCm.HasValue || !_panAngle.HasValue) return 0;
        double angleRad = _panAngle.Value * Math.PI / 180.0;
        return _distanceCm.Value * Math.Sin(angleRad);
    }

    private double CalculateY()
    {
        if (!_distanceCm.HasValue || !_panAngle.HasValue) return 0;
        double angleRad = _panAngle.Value * Math.PI / 180.0;
        return _distanceCm.Value * Math.Cos(angleRad);
    }

    private double AngleLineX(int angleDeg)
    {
        double angleRad = (angleDeg - 90) * Math.PI / 180.0;
        return 200 + RadarRadius * Math.Cos(angleRad);
    }

    private double AngleLineY(int angleDeg)
    {
        double angleRad = (angleDeg - 90) * Math.PI / 180.0;
        return 200 + RadarRadius * Math.Sin(angleRad);
    }

    private double SweepX => AngleLineX(_sweepAngle);
    private double SweepY => AngleLineY(_sweepAngle);

    private double BlipX
    {
        get
        {
            if (!_hasDetection || !_distanceCm.HasValue || !_panAngle.HasValue) return 200;
            double distance = Math.Min(_distanceCm.Value, MaxDistanceCm);
            double radius = distance / MaxDistanceCm * RadarRadius;
            double angleRad = (_panAngle.Value - 90) * Math.PI / 180.0;
            return 200 + radius * Math.Cos(angleRad);
        }
    }

    private double BlipY
    {
        get
        {
            if (!_hasDetection || !_distanceCm.HasValue || !_panAngle.HasValue) return 200;
            double distance = Math.Min(_distanceCm.Value, MaxDistanceCm);
            double radius = distance / MaxDistanceCm * RadarRadius;
            double angleRad = (_panAngle.Value - 90) * Math.PI / 180.0;
            return 200 + radius * Math.Sin(angleRad);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _componentCts = new CancellationTokenSource();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/tobothub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<double, int, string>(TobotHubEvents.ObjectDetectionCompleted, (distance, panAngle, direction) =>
        {
            _distanceCm = distance;
            _panAngle = panAngle;
            _sweepAngle = panAngle;
            _hasDetection = true;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await _hubConnection.StartAsync().ConfigureAwait(false);
            StartScanLoop();
        }
        catch { }
    }

    private void StartScanLoop()
    {
        StopScanLoop();
        _scanCts = new CancellationTokenSource();
        _scanTask = RunScanLoopAsync(_scanCts.Token);
    }

    private void StopScanLoop()
    {
        if (_scanCts is null) return;
        _scanCts.Cancel();
        _scanCts.Dispose();
        _scanCts = null;
        _scanTask = null;
    }

    private async Task RunScanLoopAsync(CancellationToken ct)
    {
        try
        {
            using var timer = new PeriodicTimer(ScanInterval);
            while (!ct.IsCancellationRequested && await timer.WaitForNextTickAsync(ct).ConfigureAwait(false))
            {
                await TriggerScan(ct).ConfigureAwait(false);
            }
        }
        catch (OperationCanceledException) { }
    }

    private async Task TriggerScan(CancellationToken ct)
    {
        if (_hubConnection is null || _hubConnection.State != HubConnectionState.Connected) return;

        try
        {
            using var linked = _componentCts is not null
                ? CancellationTokenSource.CreateLinkedTokenSource(ct, _componentCts.Token)
                : CancellationTokenSource.CreateLinkedTokenSource(ct);

            await _hubConnection.InvokeAsync(nameof(TobotHub.FindClosestObject), SamplesPerReading, SweepIncrement, linked.Token).ConfigureAwait(false);
        }
        catch { }
    }

    public async ValueTask DisposeAsync()
    {
        StopScanLoop();

        if (_componentCts is not null)
        {
            _componentCts.Cancel();
            _componentCts.Dispose();
            _componentCts = null;
        }

        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync().ConfigureAwait(false);
        }
    }
}

<style>
    html, body {
        margin: 0;
        padding: 0;
        background: #050a05;
        overflow: hidden;
    }

    .radar-screen {
        width: 800px;
        height: 480px;
        background: #050a05;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
    }

    .radar-svg {
        width: 100%;
        max-width: 760px;
        height: auto;
        flex: 1;
    }

    .sweep-line {
        transform-origin: 200px 200px;
        animation: sweep 4s linear infinite;
    }

    @@keyframes sweep {
        0%, 100% { transform: rotate(-45deg); }
        50% { transform: rotate(45deg); }
    }

    .detection-info {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 30, 10, 0.85);
        border: 1px solid #2a5a2a;
        border-radius: 4px;
        padding: 6px 14px;
        font-family: monospace;
        font-size: 13px;
        color: #5aaa5a;
        letter-spacing: 0.5px;
    }
</style>
