@page "/bot"
@implements IAsyncDisposable
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using Tobot.Web.Hubs
@inject NavigationManager Navigation
@inject Tobot.Device.TobotController Controller

<PageTitle>Tobot Bot</PageTitle>

<div class="eyes-container @GetMoodClass()" @onclick="HandleClick">
    <div class="distance-indicator">@_distanceText</div>
    <div class="eye-wrapper left-eye">
        <div class="eye">
            <div class="eyeball">
                <div class="pupil"></div>
                <div class="shine"></div>
            </div>
            <div class="eyelid"></div>
        </div>
    </div>

    <div class="eye-wrapper right-eye">
        <div class="eye">
            <div class="eyeball">
                <div class="pupil"></div>
                <div class="shine"></div>
            </div>
            <div class="eyelid"></div>
        </div>
    </div>
</div>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .eyes-container {
        width: 1280px;
        height: 720px;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 120px;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        cursor: pointer;
    }

    .distance-indicator {
        position: absolute;
        top: 20px;
        left: 20px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.6);
        color: #8df0ff;
        font-family: ui-monospace, Menlo, Consolas, monospace;
        font-size: 20px;
        border: 1px solid rgba(141, 240, 255, 0.4);
        border-radius: 6px;
        box-shadow: 0 0 12px rgba(141, 240, 255, 0.3);
        z-index: 1000;
    }

    .eye-wrapper {
        position: relative;
        animation: float 4s ease-in-out infinite;
    }

    .left-eye {
        animation-delay: 0s;
    }

    .right-eye {
        animation-delay: 0.2s;
    }

    .eye {
        position: relative;
        width: 400px;
        height: 400px;
        background: #fff;
        border-radius: 50%;
        overflow: hidden;
        box-shadow:
            0 0 40px rgba(255, 255, 255, 0.3),
            inset 0 -20px 40px rgba(0, 0, 0, 0.1);
        animation: blink 5s ease-in-out infinite;
    }

    .eyeball {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        animation: look 6s ease-in-out infinite;
    }

    .pupil {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: radial-gradient(circle at 35% 35%, #2c3e50 0%, #000 100%);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .pupil::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        background: #000;
        border-radius: 50%;
    }

    .shine {
        position: absolute;
        top: 30%;
        left: 40%;
        width: 35px;
        height: 35px;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
        border-radius: 50%;
        pointer-events: none;
    }

    .shine::after {
        content: '';
        position: absolute;
        top: 50px;
        left: -10px;
        width: 15px;
        height: 15px;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.6) 0%, transparent 60%);
        border-radius: 50%;
    }

    .eyelid {
        position: absolute;
        top: -400px;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        border-radius: 50%;
        z-index: 10;
        transition: top 0.15s ease-out;
    }

    /* Animations */
    @@keyframes float {

        0%,
        100% {
            transform: translateY(0px) scale(1);
        }

        50% {
            transform: translateY(-8px) scale(1.02);
        }
    }

    @@keyframes blink {

        0%,
        10%,
        20%,
        100% {
            /* Eyes open - eyelid stays up */
        }

        12%,
        18% {
            /* Quick blink */
        }

        12% .eyelid {
            top: 0;
        }

        18% .eyelid {
            top: -400px;
        }
    }

    .eye-wrapper:nth-child(1) .eye {
        animation: blink 4.5s ease-in-out infinite;
    }

    .eye-wrapper:nth-child(2) .eye {
        animation: blink 4.5s ease-in-out infinite 0.1s;
    }

    /* Blink effect using steps */
    @@keyframes blink {

        0%,
        88%,
        92%,
        100% {
            /* Do nothing, eyes open */
        }

        90% {
            /* Close eyes briefly */
        }
    }

    @@keyframes look {

        0%,
        100% {
            transform: translate(-50%, -50%);
        }

        20% {
            transform: translate(-48%, -52%);
        }

        40% {
            transform: translate(-52%, -50%);
        }

        60% {
            transform: translate(-50%, -48%);
        }

        80% {
            transform: translate(-51%, -51%);
        }
    }

    /* Manual blink trigger via CSS animation */
    @@keyframes blink-eyelid {

        0%,
        45%,
        55%,
        100% {
            top: -400px;
        }

        48%,
        52% {
            top: 0;
        }
    }

    .eye {
        position: relative;
    }

    .eyelid {
        animation: blink-eyelid 4s ease-in-out infinite;
    }

    .left-eye .eyelid {
        animation-delay: 0s;
    }

    .right-eye .eyelid {
        animation-delay: 0.08s;
    }

    /* Mood-specific styles */
    .eyes-container.mood-happy .eye {
        border-radius: 50% 50% 40% 40%;
        transform: scaleY(0.7) rotate(0deg);
        background: linear-gradient(180deg, #fff 0%, #fffacd 100%);
        animation: happy-bounce 0.6s ease-in-out infinite;
    }

    .eyes-container.mood-happy .pupil {
        width: 40px;
        height: 40px;
        background: radial-gradient(circle at 30% 30%, #654321 0%, #000 100%);
        animation: sparkle 1s ease-in-out infinite;
    }

    .eyes-container.mood-happy .eyeball {
        animation: look-happy 0.8s ease-in-out infinite;
    }

    .eyes-container.mood-happy .eyelid {
        animation: happy-wink 2s ease-in-out infinite;
    }

    .eyes-container.mood-terrified .eye {
        width: 500px;
        height: 500px;
        border-radius: 50%;
        background: linear-gradient(180deg, #fff 0%, #e0f0ff 100%);
        animation: tremble 0.1s ease-in-out infinite, bulge 0.5s ease-in-out infinite alternate;
        box-shadow: 0 0 40px rgba(100, 150, 255, 0.5);
    }

    .eyes-container.mood-terrified .pupil {
        width: 180px;
        height: 180px;
        background: radial-gradient(circle at 35% 35%, #000 0%, #000 100%);
        animation: dilate 0.4s ease-in-out infinite alternate;
    }

    .eyes-container.mood-terrified .eyeball {
        animation: panic-dart 0.2s linear infinite;
    }

    .eyes-container.mood-terrified .eyelid {
        animation: none !important;
        top: -600px !important;
    }

    .eyes-container.mood-angry .eye {
        border-radius: 50%;
        background: linear-gradient(180deg, #ffcccc 0%, #ff6666 100%);
        transform: scaleX(1.1) scaleY(0.85) rotate(0deg);
        animation: angry-pulse 0.8s ease-in-out infinite;
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.6), inset 0 0 20px rgba(255, 0, 0, 0.2);
    }

    .eyes-container.mood-angry .pupil {
        width: 30px;
        height: 50px;
        background: radial-gradient(circle at 35% 35%, #8b0000 0%, #000 100%);
        border-radius: 50%;
        animation: angry-contract 1s ease-in-out infinite;
    }

    .eyes-container.mood-angry .eyeball {
        animation: look-angry 0.5s ease-in-out infinite, angry-intensify 1.5s ease-in-out infinite;
    }

    .eyes-container.mood-angry .eyelid {
        animation: angry-squint 1s ease-in-out infinite;
        transform: rotate(-15deg);
    }

    @@keyframes happy-bounce {

        0%,
        100% {
            transform: scaleY(0.7) translateY(0);
        }

        50% {
            transform: scaleY(0.65) translateY(-10px);
        }
    }

    @@keyframes sparkle {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.3);
            opacity: 0.8;
        }
    }

    @@keyframes look-happy {

        0%,
        100% {
            transform: translate(-50%, -50%) rotate(-8deg) scale(1.05);
        }

        25% {
            transform: translate(-45%, -48%) rotate(8deg) scale(1.08);
        }

        75% {
            transform: translate(-55%, -52%) rotate(-8deg) scale(1.05);
        }
    }

    @@keyframes happy-wink {

        0%,
        85%,
        100% {
            top: -500px;
        }

        90%,
        95% {
            top: 0px;
        }
    }

    @@keyframes tremble {
        0% {
            transform: translate(0, 0) rotate(0deg);
        }

        10% {
            transform: translate(-3px, -2px) rotate(-1deg);
        }

        20% {
            transform: translate(3px, 2px) rotate(1deg);
        }

        30% {
            transform: translate(-2px, 3px) rotate(-0.5deg);
        }

        40% {
            transform: translate(2px, -3px) rotate(0.5deg);
        }

        50% {
            transform: translate(-3px, 1px) rotate(-1deg);
        }

        60% {
            transform: translate(3px, -1px) rotate(1deg);
        }

        70% {
            transform: translate(-1px, 2px) rotate(-0.5deg);
        }

        80% {
            transform: translate(1px, -2px) rotate(0.5deg);
        }

        90% {
            transform: translate(-2px, -1px) rotate(-1deg);
        }

        100% {
            transform: translate(2px, 1px) rotate(1deg);
        }
    }

    @@keyframes bulge {
        0% {
            transform: scale(1);
        }

        100% {
            transform: scale(1.08);
        }
    }

    @@keyframes dilate {
        0% {
            transform: translate(-50%, -50%) scale(0.95);
        }

        100% {
            transform: translate(-50%, -50%) scale(1.15);
        }
    }

    @@keyframes panic-dart {
        0% {
            transform: translate(-50%, -50%);
        }

        10% {
            transform: translate(-55%, -45%);
        }

        20% {
            transform: translate(-45%, -55%);
        }

        30% {
            transform: translate(-52%, -48%);
        }

        40% {
            transform: translate(-48%, -52%);
        }

        50% {
            transform: translate(-54%, -46%);
        }

        60% {
            transform: translate(-46%, -54%);
        }

        70% {
            transform: translate(-51%, -49%);
        }

        80% {
            transform: translate(-49%, -51%);
        }

        90% {
            transform: translate(-53%, -47%);
        }

        100% {
            transform: translate(-47%, -53%);
        }
    }

    @@keyframes angry-pulse {

        0%,
        100% {
            transform: scaleX(1.1) scaleY(0.85);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6), inset 0 0 20px rgba(255, 0, 0, 0.2);
        }

        50% {
            transform: scaleX(1.15) scaleY(0.8);
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.9), inset 0 0 30px rgba(255, 0, 0, 0.4);
        }
    }

    @@keyframes angry-contract {

        0%,
        100% {
            transform: translate(-50%, -50%) scaleY(1);
        }

        50% {
            transform: translate(-50%, -50%) scaleY(1.2);
        }
    }

    @@keyframes look-angry {

        0%,
        100% {
            transform: translate(-50%, -42%);
        }

        50% {
            transform: translate(-50%, -38%);
        }
    }

    @@keyframes angry-intensify {

        0%,
        100% {
            filter: brightness(1);
        }

        50% {
            filter: brightness(1.2);
        }
    }

    @@keyframes angry-squint {

        0%,
        100% {
            top: -250px;
        }

        50% {
            top: -200px;
        }
    }

    /* Friendly hover interaction */
    .eye-wrapper:hover .eye {
        transform: scale(1.08);
        transition: transform 0.3s ease;
    }

    .eye-wrapper:hover .pupil {
        width: 90px;
        height: 90px;
        transition: all 0.3s ease;
    }

    /* Add a subtle glow on hover */
    .eye-wrapper:hover .eye {
        box-shadow:
            0 0 60px rgba(100, 200, 255, 0.6),
            inset 0 -20px 40px rgba(0, 0, 0, 0.1);
    }
</style>

@code {
    /// <summary>
    /// Represents different emotional states of the robot eyes.
    /// </summary>
    private enum Mood
    {
        /// <summary>
        /// Neutral mood.
        /// </summary>
        Neutral,

        /// <summary>
        /// Happy mood.
        /// </summary>
        Happy,
        /// <summary>
        /// Terrified mood.
        /// </summary>
        Terrified,
        /// <summary>
        /// Angry mood.
        /// </summary>
        Angry
    }

    /// <summary>
    /// The current emotional state of the robot eyes.
    /// </summary>
    private Mood _currentMood = Mood.Neutral;


    /// <summary>
    /// Display text showing the current distance measurement from the HC-SR04 sensor.
    /// </summary>
    private string _distanceText = "-- cm";

    /// <summary>
    /// SignalR hub connection for receiving real-time distance updates from TobotHub.
    /// </summary>
    private HubConnection? _hubConnection;

    /// <summary>
    /// The last measured distance value, used for detecting increases/decreases.
    /// </summary>
    private double? _lastDistance;

    /// <summary>
    /// Cancellation token source for the 5-second neutral mood timer.
    /// </summary>
    private CancellationTokenSource? _neutralCts;

    /// <summary>
    /// Task representing the running random drive operation.
    /// </summary>
    private Task? _randomDriveTask;

    /// <summary>
    /// Returns the CSS class corresponding to the current mood.
    /// </summary>
    private string GetMoodClass()
    {
        return _currentMood switch
        {
            Mood.Happy => "mood-happy",
            Mood.Terrified => "mood-terrified",
            Mood.Angry => "mood-angry",
            _ => "mood-neutral"
        };
    }

    /// <summary>
    /// Initializes the component by setting up the SignalR connection and subscribing to distance change events.
    /// Implements reactive mood logic: Angry when distance < 10cm, Happy when distance increases, Neutral after 5 seconds.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Setup SignalR connection for distance updates
        _hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/tobothub"))
        .WithAutomaticReconnect()
        .Build();

        _hubConnection.On<double>(TobotHubEvents.DistanceChanged, cm =>
        {
            _distanceText = $"{cm:F1} cm";

            // Reactive mood logic:
            // - Start neutral
            // - If distance < 10cm → Angry
            // - If distance then increases → Happy
            // - After 5 seconds → Neutral
            var previous = _lastDistance;
            _lastDistance = cm;

            // Cancel any pending neutralization timer
            _neutralCts?.Cancel();
            _neutralCts?.Dispose();
            _neutralCts = null;

            if (cm < 10.0)
            {
                _currentMood = Mood.Angry;
            }
            else if (previous.HasValue && cm > previous.Value)
            {
                _currentMood = Mood.Happy;

                // Schedule neutral after 5 seconds
                var cts = new CancellationTokenSource();
                _neutralCts = cts;
                _ = ResetToNeutralAfterDelayAsync(cts.Token);
            }
            else
            {
                // No specific rule matched; stay in current mood
            }

            InvokeAsync(StateHasChanged);
        });

        try
        {
            await _hubConnection.StartAsync();
            
            // Start autonomous driving
            _randomDriveTask = Controller.StartRandomDrive(
                forwardSpeed: 50,
                turnSpeed: 40,
                obstacleDistanceCm: 20.0,
                clearDistanceCm: 30.0);
        }
        catch
        {
            _distanceText = "(no hub)";
        }
    }

    /// <summary>
    /// Resets the mood to Neutral after a 5-second delay if not cancelled.
    /// </summary>
    /// <param name="cancellationToken">Token to cancel the delayed reset.</param>
    private async Task ResetToNeutralAfterDelayAsync(CancellationToken cancellationToken)
    {
        try
        {
            await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken).ConfigureAwait(false);
            _currentMood = Mood.Neutral;
            await InvokeAsync(StateHasChanged);
        }
        catch (TaskCanceledException)
        {
            // Expected when mood changes before delay completes
        }
    }

    /// <summary>
    /// Handles click events on the page to stop autonomous driving.
    /// </summary>
    private void HandleClick()
    {
        Controller.StopRandomDrive();
    }

    /// <summary>
    /// Disposes of resources including the cancellation token source and SignalR hub connection.
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        _neutralCts?.Cancel();
        _neutralCts?.Dispose();
        
        Controller.StopRandomDrive();
        
        if (_randomDriveTask is not null)
        {
            try
            {
                await _randomDriveTask.ConfigureAwait(false);
            }
            catch
            {
                // Ignore cancellation exceptions
            }
        }
        
        if (_hubConnection is not null)
        {
            try
            {
                await _hubConnection.StopAsync().ConfigureAwait(false);
            }
            catch
            {
                // Ignore disposal errors
            }
            
            await _hubConnection.DisposeAsync().ConfigureAwait(false);
        }
    }
}